{"version":3,"sources":["api/senderId/senderId.controller.js"],"names":["create","deleteSenderId","index","show","approve","block","createXls","ADMIN","handleError","res","argStatusCode","err","error","statusCode","status","send","req","SenderId","findAll","attributes","where","name","body","createdBy","user","id","then","senderIds","userSenderId","filter","x","json","message","length","updatedBy","senderId","blockedSenderId","approvedSenderId","catch","destroy","params","data","next","roleId","query","fl","promise","admin","resolve","User","loginUrl","origin","users","senderIdStatusId","$not","map","$and","split","include","model","as","limit","offset","options","Number","reduce","nxt","key","value","all","Selling","count","routes","numFound","items","meta","find","update","end","wb","Workbook","ws","addWorksheet","cell","string","forEach","item","i","write"],"mappings":"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","file":"senderId.controller.js","sourcesContent":["import xl from 'excel4node';\nimport logger from '../../components/logger';\nimport { ROLES } from '../../config/constants';\nimport { notifyAdminSenderIdApproval } from '../../components/senderId';\nimport db from '../../conn/sqldb';\n\nconst { ADMIN } = ROLES;\n\nfunction handleError(res, argStatusCode, err) {\n  logger.error('user.controller', err);\n  const statusCode = argStatusCode || 500;\n  res.status(statusCode).send(err);\n}\n\nexport function create(req, res) {\n  return db.SenderId\n    .findAll({\n      attributes: ['id', 'status', 'createdBy'],\n      where: { name: req.body.name, createdBy: req.user.id },\n    }).then((senderIds) => {\n      const userSenderId = senderIds.filter(x => (x.createdBy === req.user.id))[0];\n      if (userSenderId) {\n        if (userSenderId.status === 1) {\n          return res.json({ message: 'Approval Pending.' });\n        }\n        if (userSenderId.status === 2) {\n          return res.status(500).json({ message: 'Blocked.' });\n        }\n        return res.status(500).json({ message: 'Duplicate' });\n      }\n      if (!senderIds.length) {\n        return db.SenderId.create(Object\n          .assign({}, req.body, { createdBy: req.user.id, updatedBy: req.user.id }))\n          .then((senderId) => {\n            notifyAdminSenderIdApproval(senderId);\n            return res.json({ message: 'success' });\n          });\n      }\n      const blockedSenderId = senderIds.filter(x => (x.status === 3))[0];\n      const approvedSenderId = senderIds.filter(x => (x.status === 2))[0];\n      if (!blockedSenderId && approvedSenderId) {\n        return db.SenderId.create(Object.assign(\n          { status: approvedSenderId.status },\n          req.body,\n          { createdBy: req.user.id, updatedBy: req.user.id }))\n          .then((senderId) => {\n            notifyAdminSenderIdApproval(senderId);\n            return res.json({ message: 'success' });\n          });\n      }\n      return db.SenderId.create(Object.assign(\n        {},\n        req.body,\n        { createdBy: req.user.id, updatedBy: req.user.id }))\n        .then((senderId) => {\n          notifyAdminSenderIdApproval(senderId);\n          return res.json({ message: 'success' });\n        });\n    })\n    .catch(err => handleError(res, 500, err));\n}\n\nexport function deleteSenderId(req, res) {\n  return db.SenderId.destroy({ where: { id: req.params.id } })\n    .then(data => res.json(data))\n    .catch(err => handleError(res, 500, err));\n}\n\nexport function index(req, res, next) {\n  if (req.user.roleId !== ADMIN) {\n    const { status, fl } = req.query;\n    let promise;\n    if (req.user.admin === 2) {\n      promise = Promise.resolve();\n    } else if (req.user.admin) {\n      promise = db.User.findAll({ attributes: ['id'], where: { loginUrl: req.origin } });\n    } else {\n      promise = Promise.resolve([req.user]);\n    }\n    return promise\n      .then((users) => {\n        const where = { senderIdStatusId: { $not: 3 } };\n        if (users) where.createdBy = users.map(x => x.id);\n        if (status) where.$and = { senderIdStatusId: status.split(',') };\n        return db.SenderId.findAll({\n          attributes: fl ? fl.split(',') : ['id', 'name'],\n          where,\n          include: [{\n            model: db.User,\n            as: 'CreatedBy',\n            attributes: ['id', 'name', 'admin'],\n          }] })\n          .then(data => res.json(data));\n      })\n      .catch(err => handleError(res, 500, err));\n  }\n\n\n  const { limit = 20, offset = 0, fl, where } = req.query;\n\n  const options = {\n    attributes: fl ? fl.split(',') : ['id', 'routeId', 'limit', 'userId'],\n    limit: Number(limit),\n    offset: Number(offset),\n  };\n\n  if (where) {\n    options.where = where.split(',').reduce((nxt, x) => {\n      const [key, value] = x.split(':');\n      return Object.assign(nxt, { [key]: value });\n    }, {});\n  }\n\n  return Promise\n    .all([\n      db.Selling\n        .findAll(options),\n      db.Selling\n        .count(),\n    ])\n    .then(([routes, numFound]) => res.json({ items: routes, meta: { numFound } }))\n    .catch(next);\n}\n\nexport function show(req, res) {\n  let promise;\n  if (req.user.admin === 2) {\n    promise = Promise.resolve();\n  } else if (req.user.admin) {\n    promise = db.User.findAll({ attributes: ['id'], where: { loginUrl: req.origin } });\n  } else {\n    promise = Promise.resolve([req.user]);\n  }\n  return promise\n    .then((users) => {\n      const where = { id: req.params.id };\n      if (users) where.createdBy = users.map(x => x.id);\n      return db.SenderId.find({\n        where,\n        include: [{\n          model: db.User,\n          as: 'CreatedBy',\n          attributes: ['id', 'name', 'admin'],\n        }] })\n        .then(data => res.json(data));\n    })\n    .catch(err => handleError(res, 500, err));\n}\n\nexport function approve(req, res) {\n  return db.SenderId.update({ status: true }, { where: { id: req.params.id } })\n    .then(() => res.status(202).end())\n    .catch(err => handleError(res, 500, err));\n}\n\nexport function block(req, res) {\n  return db.SenderId.update({ status: false }, { where: { id: req.params.id } })\n    .then(() => res.status(202).end())\n    .catch(err => handleError(res, 500, err));\n}\n\nexport function createXls(req, res, next) {\n  return db.SenderId\n    .findAll({})\n    .then((data) => {\n      const senderId = data.map(x => x.name);\n      const wb = new xl.Workbook();\n      const ws = wb.addWorksheet('Sheet 1');\n      ws.cell(1, 1).string('Sender Ids');\n      senderId.forEach((item, i) => {\n        ws.cell(i + 2, 1).string(item);\n      });\n      wb.write('Excel.xlsx', res);\n    })\n    .catch(next);\n}\n"]}