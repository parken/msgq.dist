{"version":3,"sources":["api/template/template.controller.js"],"names":["index","show","create","activate","update","destroy","CUSTOMER","req","res","next","user","roleId","Template","findAll","attributes","where","userId","id","then","json","data","catch","query","limit","offset","fl","options","split","Number","reduce","nxt","x","key","value","all","count","templates","numFound","items","meta","findById","params","template","body","createdBy","updatedBy","status","routeId","deactivateOtherRoutes","active","end"],"mappings":"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","file":"template.controller.js","sourcesContent":["import logger from '../../components/logger';\nimport db from '../../conn/sqldb';\nimport { ROLES } from '../../config/constants';\n\nconst { CUSTOMER } = ROLES;\n\nexport function index(req, res, next) {\n  if (req.user.roleId === CUSTOMER) {\n    return db.Template\n      .findAll({\n        attributes: ['id', 'name', 'content'],\n        where: { userId: req.user.id },\n      })\n      .then(data => res.json(data))\n      .catch(next);\n  }\n\n\n  const { limit = 20, offset = 0, fl, where } = req.query;\n\n  const options = {\n    attributes: fl ? fl.split(',') : ['id', 'name'],\n    limit: Number(limit),\n    offset: Number(offset),\n  };\n\n  if (where) {\n    options.where = where.split(',').reduce((nxt, x) => {\n      const [key, value] = x.split(':');\n      return Object.assign(nxt, { [key]: value });\n    }, {});\n  }\n\n  return Promise\n    .all([\n      db.Template\n        .findAll(options),\n      db.Template\n        .count(),\n    ])\n    .then(([templates, numFound]) => res.json({ items: templates, meta: { numFound } }))\n    .catch(next);\n}\n\nexport function show(req, res, next) {\n  return db.Template\n    .findById(req.params.id)\n    .then(template => res.json(template))\n    .catch(next);\n}\n\nexport function create(req, res, next) {\n  return db.Template\n    .create(Object.assign({}, req.body, {\n      createdBy: req.user.id,\n      updatedBy: req.user.id,\n    }))\n    .then(({ id }) => res.status(201).json({ id }))\n    .catch(next);\n}\n\nexport function activate(req, res, next) {\n  const { id } = req.params;\n  db.Template\n    .findById(id)\n    .then(({ routeId }) => db.Template\n      .deactivateOtherRoutes(db, { routeId }))\n    .then(() => db.Template\n      .update({ active: true }, { where: { id } }))\n    .then(() => res.status(201).end())\n    .catch(next);\n}\n\nexport function update(req, res, next) {\n  return db.Template\n    .update(\n      Object.assign({}, req.body, {\n        active: false,\n        updatedBy: req.user.id,\n      }),\n      { where: { id: req.params.id } })\n    .then(() => res.status(201).end())\n    .catch(next);\n}\n\nexport function destroy(req, res, next) {\n  return db.Template\n    .destroy({ where: { id: req.params.id } })\n    .then(() => res.status(201).end())\n    .catch(next);\n}\n"]}