{"version":3,"sources":["api/user/user.model.js"],"names":["sequelize","DataTypes","User","define","id","type","INTEGER","allowNull","primaryKey","autoIncrement","name","STRING","mobile","email","signature","otp","otpStatus","password","active","BOOLEAN","admin","companyName","companyAddress","companyLogo","supportName","supportMobile","BIGINT","supportEmail","loginUrl","slackUrl","slackActive","smsActive","transactionalStartFrom","transactionalPercent","promotionalStartFrom","promotionalPercent","otpStartFrom","otpPercent","senderIdStartFrom","senderIdPercent","expiresAt","DATE","sellingBalanceTransactional","sendingBalanceTransactional","sellingBalancePromotional","sendingBalancePromotional","sellingBalanceSenderId","sendingBalanceSenderId","sellingBalanceOTP","sendingBalanceOTP","tableName","timestamps","paranoid","instanceMethods","hashPassword","createHash","update","salt","digest","verifyPasswordAsync","hashedPass","resolve","pick","toJSON","reject","code","message","verifyPassword","cb","revokeTokens","db","expires","Date","all","AccessToken","where","userId","RefreshToken","classMethods","associate","belongsTo","Role","foreignKey","App","as","checkEmailExists","count","then","rows","checkMobileExists","checkExists","e","m","hooks","beforeCreate","instance","changed","set","beforeUpdate"],"mappings":";;;;;;;;;;;;;;kBAMe,UAAUA,SAAV,EAAqBC,SAArB,EAAgC;AAC7C,MAAMC,OAAOF,UAAUG,MAAV,CAAiB,MAAjB,EAAyB;AACpCC,QAAI;AACFC,YAAMJ,UAAUK,OADd;AAEFC,iBAAW,KAFT;AAGFC,kBAAY,IAHV;AAIFC,qBAAe;AAJb,KADgC;AAOpCC,UAAMT,UAAUU,MAPoB;AAQpCC,YAAQX,UAAUK,OARkB;AASpCO,WAAOZ,UAAUU,MATmB;AAUpCG,eAAWb,UAAUU,MAVe;AAWpCI,SAAKd,UAAUU,MAXqB;AAYpCK,eAAWf,UAAUK,OAZe;AAapCW,cAAUhB,UAAUU,MAbgB;AAcpCO,YAAQjB,UAAUkB,OAdkB;AAepCC,WAAOnB,UAAUK,OAfmB;AAgBpCe,iBAAapB,UAAUU,MAhBa;AAiBpCW,oBAAgBrB,UAAUU,MAjBU;AAkBpCY,iBAAatB,UAAUU,MAlBa;AAmBpCa,iBAAavB,UAAUU,MAnBa;AAoBpCc,mBAAexB,UAAUyB,MApBW;AAqBpCC,kBAAc1B,UAAUU,MArBY;AAsBpCiB,cAAU3B,UAAUU,MAtBgB;AAuBpCkB,cAAU5B,UAAUU,MAvBgB;AAwBpCmB,iBAAa7B,UAAUkB,OAxBa;AAyBpCY,eAAW9B,UAAUkB,OAzBe;AA0BpCa,4BAAwB/B,UAAUK,OA1BE;AA2BpC2B,0BAAsBhC,UAAUK,OA3BI;AA4BpC4B,0BAAsBjC,UAAUK,OA5BI;AA6BpC6B,wBAAoBlC,UAAUK,OA7BM;AA8BpC8B,kBAAcnC,UAAUK,OA9BY;AA+BpC+B,gBAAYpC,UAAUK,OA/Bc;AAgCpCgC,uBAAmBrC,UAAUK,OAhCO;AAiCpCiC,qBAAiBtC,UAAUK,OAjCS;AAkCpCkC,eAAWvC,UAAUwC,IAlCe;AAmCpCC,iCAA6BzC,UAAUK,OAnCH;AAoCpCqC,iCAA6B1C,UAAUK,OApCH;AAqCpCsC,+BAA2B3C,UAAUK,OArCD;AAsCpCuC,+BAA2B5C,UAAUK,OAtCD;AAuCpCwC,4BAAwB7C,UAAUK,OAvCE;AAwCpCyC,4BAAwB9C,UAAUK,OAxCE;AAyCpC0C,uBAAmB/C,UAAUK,OAzCO;AA0CpC2C,uBAAmBhD,UAAUK;AA1CO,GAAzB,EA2CV;AACD4C,eAAW,OADV;AAEDC,gBAAY,IAFX;AAGDC,cAAU,IAHT;AAIDC,qBAAiB;AACfC,kBADe,wBACFrC,QADE,EACQ;AACrB,eAAO,iBACJsC,UADI,CACO,KADP,EAEJC,MAFI,CAEGC,OAAOxC,QAFV,EAGJyC,MAHI,CAGG,KAHH,CAAP;AAID,OANc;AAOfC,yBAPe,+BAOK1C,QAPL,EAOe;AAC5B,YAAM2C,aAAa,iBAChBL,UADgB,CACL,KADK,EAEhBC,MAFgB,CAETC,OAAOxC,QAFE,EAGhByC,MAHgB,CAGT,KAHS,CAAnB;AAIA,eAAQE,eAAe,KAAK3C,QAArB,GAAiC,kBAAQ4C,OAAR,CAAgB,iBAAEC,IAAF,CAAO,KAAKC,MAAL,EAAP,EAAsB,CAAC,IAAD,CAAtB,CAAhB,CAAjC,GACH,kBAAQC,MAAR,CAAe,EAAEC,MAAM,GAAR,EAAaC,SAAS,iBAAtB,EAAf,CADJ;AAED,OAdc;AAefC,oBAfe,0BAeAlD,QAfA,EAeUmD,EAfV,EAec;AAC3B,eAAQlE,KAAKoD,YAAL,CAAkBrC,QAAlB,MAAgC,KAAKA,QAAtC,GACLmD,GAAG,IAAH,EAAS,KAAKL,MAAL,EAAT,CADK,GACqBK,GAAG,IAAH,EAAS,KAAT,CAD5B;AAED,OAlBc;AAoBfC,kBApBe,wBAoBFC,EApBE,EAoBE;AACf,YAAMC,UAAU,IAAIC,IAAJ,EAAhB;AACA,eAAO,kBAAQC,GAAR,CAAY,CACjBH,GAAGI,WAAH,CAAelB,MAAf,CACE,EAAEe,gBAAF,EADF,EAEE,EAAEI,OAAO,EAAEC,QAAQ,KAAKxE,EAAf,EAAT,EAFF,CADiB,EAIjBkE,GAAGO,YAAH,CAAgBrB,MAAhB,CACE,EAAEe,gBAAF,EADF,EAEE,EAAEI,OAAO,EAAEC,QAAQ,KAAKxE,EAAf,EAAT,EAFF,CAJiB,CAAZ,CAAP;AAQD;AA9Bc,KAJhB;;AAqCD0E,kBAAc;AACZC,eADY,qBACFT,EADE,EACE;AACZ,aAAKA,EAAL,GAAUA,EAAV;AACApE,aAAK8E,SAAL,CAAeV,GAAGW,IAAlB,EAAwB;AACtBC,sBAAY;AADU,SAAxB;AAGAhF,aAAK8E,SAAL,CAAeV,GAAGa,GAAlB,EAAuB;AACrBD,sBAAY;AADS,SAAvB;AAGAhF,aAAK8E,SAAL,CAAe9E,IAAf,EAAqB;AACnBgF,sBAAY,WADO;AAEnB3E,qBAAW,IAFQ;AAGnB6E,cAAI;AAHe,SAArB;AAKAlF,aAAK8E,SAAL,CAAe9E,IAAf,EAAqB;AACnBgF,sBAAY,YADO;AAEnB3E,qBAAW,IAFQ;AAGnB6E,cAAI;AAHe,SAArB;AAKD,OAnBW;AAoBZC,sBApBY,4BAoBKf,EApBL,EAoBSzD,KApBT,EAoBgB;AAC1B,eAAOyD,GAAGpE,IAAH,CAAQoF,KAAR,CAAc,EAAEX,OAAO,EAAE9D,YAAF,EAAT,EAAd,EAAoC0E,IAApC,CAAyC,UAACC,IAAD,EAAU;AACxD,cAAIA,OAAO,CAAX,EAAc,OAAO,kBAAQ3B,OAAR,CAAgB,IAAhB,CAAP;AACd,iBAAO,kBAAQA,OAAR,CAAgB,KAAhB,CAAP;AACD,SAHM,CAAP;AAID,OAzBW;AA0BZ4B,uBA1BY,6BA0BMnB,EA1BN,EA0BU1D,MA1BV,EA0BkB;AAC5B,eAAO0D,GAAGpE,IAAH,CAAQoF,KAAR,CAAc,EAAEX,OAAO,EAAE/D,cAAF,EAAT,EAAd,EAAqC2E,IAArC,CAA0C,UAACC,IAAD,EAAU;AACzD,cAAIA,OAAO,CAAX,EAAc,OAAO,kBAAQ3B,OAAR,CAAgB,IAAhB,CAAP;AACd,iBAAO,kBAAQA,OAAR,CAAgB,KAAhB,CAAP;AACD,SAHM,CAAP;AAID,OA/BW;AAgCZ6B,iBAhCY,uBAgCApB,EAhCA,EAgCIzD,KAhCJ,EAgCWD,MAhCX,EAgCmB;AAC7B,eAAO,kBAAQ6D,GAAR,CAAY,CACjB5D,QAAQyD,GAAGpE,IAAH,CAAQmF,gBAAR,CAAyBf,EAAzB,EAA6BzD,KAA7B,CAAR,GAA8C,kBAAQgD,OAAR,CAAgB,KAAhB,CAD7B,EAEjBjD,SAAS0D,GAAGpE,IAAH,CAAQuF,iBAAR,CAA0BnB,EAA1B,EAA8B1D,MAA9B,CAAT,GAAiD,kBAAQiD,OAAR,CAAgB,KAAhB,CAFhC,CAAZ,EAIJ0B,IAJI,CAIC;AAAA;AAAA,cAAEI,CAAF;AAAA,cAAKC,CAAL;;AAAA,iBAAa,EAAE/E,OAAO8E,CAAT,EAAY/E,QAAQgF,CAApB,EAAb;AAAA,SAJD,CAAP;AAKD,OAtCW;AAuCZtC,kBAvCY,wBAuCCrC,QAvCD,EAuCW;AACrB,eAAO,iBACJsC,UADI,CACO,KADP,EAEJC,MAFI,CAEGC,OAAOxC,QAFV,EAGJyC,MAHI,CAGG,KAHH,CAAP;AAID;AA5CW,KArCb;AAmFDmC,WAAO;AACLC,kBADK,wBACQC,QADR,EACkB;AACrB,YAAIA,SAASC,OAAT,CAAiB,UAAjB,CAAJ,EAAkC;AAChCD,mBACGE,GADH,CACO,UADP,EACmB,KAAK3B,EAAL,CAAQpE,IAAR,CAAaoD,YAAb,CAA0ByC,SAAS9E,QAAnC,CADnB;AAED;AACF,OANI;AAQLiF,kBARK,wBAQQH,QARR,EAQkB;AACrB,YAAIA,SAASC,OAAT,CAAiB,UAAjB,CAAJ,EAAkC;AAChCD,mBACGE,GADH,CACO,UADP,EACmBF,SAASzC,YAAT,CAAsByC,SAAS9E,QAA/B,CADnB;AAED;AACF;AAbI;AAnFN,GA3CU,CAAb;;AA+IA,SAAOf,IAAP;AACD,C;;AAtJD;;;;AACA;;;;;;AAEA,IAAMuD,OAAO,kEAAb","file":"user.model.js","sourcesContent":["\nimport _ from 'lodash';\nimport crypto from 'crypto';\n\nconst salt = 'DYhG93b0fIxfs2guVoUubasdfajfkljasdjfaklsdjflakrfWwvniR2G0FgaC9mi';\n\nexport default function (sequelize, DataTypes) {\n  const User = sequelize.define('User', {\n    id: {\n      type: DataTypes.INTEGER,\n      allowNull: false,\n      primaryKey: true,\n      autoIncrement: true,\n    },\n    name: DataTypes.STRING,\n    mobile: DataTypes.INTEGER,\n    email: DataTypes.STRING,\n    signature: DataTypes.STRING,\n    otp: DataTypes.STRING,\n    otpStatus: DataTypes.INTEGER,\n    password: DataTypes.STRING,\n    active: DataTypes.BOOLEAN,\n    admin: DataTypes.INTEGER,\n    companyName: DataTypes.STRING,\n    companyAddress: DataTypes.STRING,\n    companyLogo: DataTypes.STRING,\n    supportName: DataTypes.STRING,\n    supportMobile: DataTypes.BIGINT,\n    supportEmail: DataTypes.STRING,\n    loginUrl: DataTypes.STRING,\n    slackUrl: DataTypes.STRING,\n    slackActive: DataTypes.BOOLEAN,\n    smsActive: DataTypes.BOOLEAN,\n    transactionalStartFrom: DataTypes.INTEGER,\n    transactionalPercent: DataTypes.INTEGER,\n    promotionalStartFrom: DataTypes.INTEGER,\n    promotionalPercent: DataTypes.INTEGER,\n    otpStartFrom: DataTypes.INTEGER,\n    otpPercent: DataTypes.INTEGER,\n    senderIdStartFrom: DataTypes.INTEGER,\n    senderIdPercent: DataTypes.INTEGER,\n    expiresAt: DataTypes.DATE,\n    sellingBalanceTransactional: DataTypes.INTEGER,\n    sendingBalanceTransactional: DataTypes.INTEGER,\n    sellingBalancePromotional: DataTypes.INTEGER,\n    sendingBalancePromotional: DataTypes.INTEGER,\n    sellingBalanceSenderId: DataTypes.INTEGER,\n    sendingBalanceSenderId: DataTypes.INTEGER,\n    sellingBalanceOTP: DataTypes.INTEGER,\n    sendingBalanceOTP: DataTypes.INTEGER,\n  }, {\n    tableName: 'users',\n    timestamps: true,\n    paranoid: true,\n    instanceMethods: {\n      hashPassword(password) {\n        return crypto\n          .createHash('md5')\n          .update(salt + password)\n          .digest('hex');\n      },\n      verifyPasswordAsync(password) {\n        const hashedPass = crypto\n          .createHash('md5')\n          .update(salt + password)\n          .digest('hex');\n        return (hashedPass === this.password) ? Promise.resolve(_.pick(this.toJSON(), ['id']))\n          : Promise.reject({ code: 400, message: 'Check password!' });\n      },\n      verifyPassword(password, cb) {\n        return (User.hashPassword(password) === this.password) ?\n          cb(null, this.toJSON()) : cb(null, false);\n      },\n\n      revokeTokens(db) {\n        const expires = new Date();\n        return Promise.all([\n          db.AccessToken.update(\n            { expires },\n            { where: { userId: this.id } }),\n          db.RefreshToken.update(\n            { expires },\n            { where: { userId: this.id } }),\n        ]);\n      },\n    },\n\n    classMethods: {\n      associate(db) {\n        this.db = db;\n        User.belongsTo(db.Role, {\n          foreignKey: 'roleId',\n        });\n        User.belongsTo(db.App, {\n          foreignKey: 'appId',\n        });\n        User.belongsTo(User, {\n          foreignKey: 'createdBy',\n          allowNull: true,\n          as: 'CreatedBy',\n        });\n        User.belongsTo(User, {\n          foreignKey: 'resellerId',\n          allowNull: true,\n          as: 'ResellerId',\n        });\n      },\n      checkEmailExists(db, email) {\n        return db.User.count({ where: { email } }).then((rows) => {\n          if (rows > 0) return Promise.resolve(true);\n          return Promise.resolve(false);\n        });\n      },\n      checkMobileExists(db, mobile) {\n        return db.User.count({ where: { mobile } }).then((rows) => {\n          if (rows > 0) return Promise.resolve(true);\n          return Promise.resolve(false);\n        });\n      },\n      checkExists(db, email, mobile) {\n        return Promise.all([\n          email ? db.User.checkEmailExists(db, email) : Promise.resolve(false),\n          mobile ? db.User.checkMobileExists(db, mobile) : Promise.resolve(false),\n        ])\n          .then(([e, m]) => ({ email: e, mobile: m }));\n      },\n      hashPassword(password) {\n        return crypto\n          .createHash('md5')\n          .update(salt + password)\n          .digest('hex');\n      },\n    },\n    hooks: {\n      beforeCreate(instance) {\n        if (instance.changed('password')) {\n          instance\n            .set('password', this.db.User.hashPassword(instance.password));\n        }\n      },\n\n      beforeUpdate(instance) {\n        if (instance.changed('password')) {\n          instance\n            .set('password', instance.hashPassword(instance.password));\n        }\n      },\n    },\n  });\n\n  return User;\n}\n"]}