{"version":3,"sources":["api/user/user.controller.js"],"names":["me","meUpdate","index","show","showUuid","create","createEndUser","createCustomer","signup","googleLogin","login","refresh","logout","duplicate","update","checkExists","otpLogin","otpSend","otpVerify","passwordChange","sendLogin","loginUid","addSellingRootUser","addSelling","ADMIN","req","res","next","query","fl","includes","User","findById","user","id","attributes","raw","then","json","catch","all","Route","findAll","u","upstreams","signature","body","where","limit","offset","options","split","Number","reduce","nxt","x","key","value","roleId","resellerId","count","users","numFound","items","meta","find","params","data","_","omit","LoginIdentifier","uuid","include","model","required","loginIdentifier","status","message","mobile","length","supportMobile","createdBy","otp","Math","floor","random","email","resolve","authorization","get","Buffer","from","toString","clientId","clientSecret","App","app","name","password","$or","appId","push","end","getApp","code","AuthCode","auth_code","authCode","toJSON","method","uri","OAUTH_SERVER","OAUTH_ENDPOINT","auth","pass","headers","connection","remoteAddress","form","grant_type","username","url","redirect_uri","redirectUri","post","err","apires","statusCode","send","RefreshToken","refreshToken","refresh_token","revokeToken","access_token","up","findOrCreate","newUser","otpStatus","text","to","error","error_description","revokeTokens","origin","userId","routeId","Selling","updatedBy","sendingUserId","fromUserId"],"mappings":"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","file":"user.controller.js","sourcesContent":["import request from 'request';\nimport rp from 'request-promise';\nimport config from '../../config/environment';\nimport { ROLES } from '../../config/constants';\nimport logger from '../../components/logger';\nimport { sms, slack } from '../../components/notify';\nimport oAuthModel from '../../components/oauth/model';\nimport { getRouteType } from '../../conn/sqldb/helper';\n\nimport db from '../../conn/sqldb';\n\nconst { ADMIN } = ROLES;\nexport function me(req, res, next) {\n  if (req.query.fl && req.query.fl.includes('sign')) {\n    return db.User\n      .findById(req.user.id, { attributes: ['signature'], raw: true })\n      .then(user => res.json(user))\n      .catch(next);\n  }\n\n  return Promise.all([\n    db.User\n      .findById(req.user.id, {\n        attributes: ['mobile', 'email', 'name', 'id', 'roleId', 'admin', 'companyName',\n          'companyAddress', 'supportName', 'supportMobile', 'supportEmail'],\n        raw: 'true',\n      }),\n    db.Route.findAll(),\n  ])\n    .then(([u, upstreams]) => res.json(Object.assign(u, { upstreams })))\n    .catch(next);\n}\n\nexport function meUpdate(req, res, next) {\n  if (req.query.fl.includes('sign')) return next();\n\n  return db.User\n    .update({ signature: req.body.signature }, { where: { id: req.user.id } })\n    .then(user => res.json(user))\n    .catch(next);\n}\n\n\nexport function index(req, res, next) {\n  const { limit = 20, offset = 0, fl, where } = req.query;\n\n  const options = {\n    where: {},\n    attributes: fl ? fl.split(',') : ['id', 'name'],\n    limit: Number(limit),\n    offset: Number(offset),\n  };\n\n  if (where) {\n    options.where = where.split(',').reduce((nxt, x) => {\n      const [key, value] = x.split(':');\n      return Object.assign(nxt, { [key]: value });\n    }, {});\n  }\n\n  if (req.user.roleId !== ADMIN) {\n    options.where.resellerId = req.user.id;\n  }\n\n  return Promise\n    .all([\n      db.User\n        .findAll(options),\n      db.User\n        .count(),\n    ])\n    .then(([users, numFound]) => res.json({ items: users, meta: { numFound } }))\n    .catch(next);\n}\n\nexport function show(req, res, next) {\n  switch (req.user.roleId) {\n    case 1:\n    case 2: {\n      return db.User\n        .find({\n          attributes: ['id', 'name', 'email', 'mobile'],\n          where: { id: req.params.id },\n        })\n        .then(data => res.json(data))\n        .catch(next);\n    }\n    default: {\n      return db.User\n        .find({\n          where: { id: req.params.id },\n          attributes: ['id', 'name', 'email', 'mobile'],\n        })\n        .then(data => res.json(_.omit(data, ['password'])))\n        .catch(next);\n    }\n  }\n}\n\nexport function showUuid(req, res, next) {\n  return db.LoginIdentifier\n    .find({\n      where: { uuid: req.params.uuid },\n      attributes: ['id'],\n      include: [{\n        model: db.User,\n        attributes: ['id', 'mobile', 'otp'],\n        required: true,\n      }],\n    })\n    .then((loginIdentifier) => {\n      if (!loginIdentifier) return res.status(400).json({ message: 'Invalid Request' });\n      return res.json(loginIdentifier.User);\n    })\n    .catch(next);\n}\n\nexport function create(req, res, next) {\n  const user = req.body;\n  if (`${user.mobile}`.length === 10) user.mobile = Number(`91${user.mobile}`);\n  if (`${user.supportMobile}`.length === 10) user.supportMobile = Number(`91${user.supportMobile}`);\n  user.roleId = req.user.roleId + 1;\n  user.createdBy = req.user.id;\n\n  if (req.user.roleId !== ADMIN) {\n    user.resellerId = req.user.resellerId || req.user.id;\n  }\n\n  return db.User\n    .create(user)\n    .then(data => res.json(data))\n    .catch(next);\n}\n\nexport function createEndUser(req, res, next) {\n  const user = req.body;\n  user.roleId = 4;\n  user.createdBy = req.user.id;\n  user.otp = Math.floor(Math.random() * 90000) + 10000;\n  delete user.id;\n  return db.User\n    .find({ where: { email: user.email, createdBy: user.createdBy, roleId: user.roleId } })\n    .then(data => (data\n      ? Promise.resolve(data)\n      : db.User.create(user)))\n    .then(data => res.json(data))\n    .catch(next);\n}\n\nexport function createCustomer(req, res, next) {\n  const user = req.body;\n  user.roleId = 5;\n  user.createdBy = req.user.id;\n  user.otp = Math.floor(Math.random() * 90000) + 10000;\n  delete user.id;\n  return db.User\n    .find({ where: { email: user.email, createdBy: user.createdBy, roleId: user.roleId } })\n    .then(data => (data\n      ? Promise.resolve(data)\n      : db.User.create(user)))\n    .then(data => res.json(data))\n    .catch(next);\n}\n\nexport function signup(req, res, next) {\n  const authorization = req.get('authorization');\n  if (!authorization) return res.status(403).json({ message: 'Unauthorized Access.' });\n  const [clientId, clientSecret] = Buffer.from(authorization.split(' ')[1], 'base64')\n    .toString('ascii').split(':');\n  return db.App\n    .find({ attributes: ['id'], where: { clientId, clientSecret } })\n    .then(app => {\n      if (!app) return res.status(403).json({ message: 'Invalid Authentication.' });\n      const { name, email, mobile } = req.body;\n      let { roleId } = req.body;\n      if (!roleId) roleId = 4;\n      let { password } = req.body;\n      const otp = Math.floor(Math.random() * 90000) + 10000;\n      if (!password) password = otp;\n      const where = { $or: [], appId: app.id };\n      if (email) where.$or.push({ email });\n      if (mobile) where.$or.push({ mobile });\n      return db.User.find({ where })\n        .then(user => (user\n          ? res.status(409).end()\n          : db.User.create({ name, email, mobile, otp, password, appId: app.id, roleId })\n            .then(() => res.end())));\n    })\n    .catch(next);\n}\n\nfunction getApp(code) {\n  return db.AuthCode.find({ where: { auth_code: code }, include: [db.App] })\n    .then(authCode => authCode.App.toJSON());\n}\n\nexport function googleLogin(req, res, next) {\n  const authorization = req.get('authorization');\n  if (!authorization) return res.status(403).json({ message: 'Unauthorized Access.' });\n  const [clientId, clientSecret] = Buffer.from(authorization.split(' ')[1], 'base64')\n    .toString('ascii').split(':');\n  return db.App\n    .find({ attributes: ['id', 'clientId', 'clientSecret'], where: { clientId, clientSecret } })\n    .then(app => {\n      if (!app) return res.status(400).json({ message: 'Invalid Authentication.' });\n      const { email } = req.body;\n      return db.User\n        .find({ attributes: ['email', 'otp'], where: { email, appId: app.id } })\n        .then(user => {\n          if (!user) return res.status(400).json({ message: 'user not found' });\n          const options = {\n            method: 'POST',\n            uri: `${config.OAUTH_SERVER}${config.OAUTH_ENDPOINT}`,\n            auth: {\n              user: app.clientId,\n              pass: app.clientSecret,\n            },\n            headers: {\n              'user-agent': req.headers['user-agent'],\n              'x-forwarded-for': req.headers['x-forwarded-for'] || req.connection.remoteAddress,\n            },\n            form: {\n              grant_type: 'password',\n              username: user.email,\n              password: user.otp,\n            },\n            json: true,\n          };\n          return rp(options).then(data => res.json(data));\n        });\n    })\n    .catch(next);\n}\n\nexport function login(req, res, next) {\n  const { code } = req.body;\n  return (code\n    ? getApp(code)\n    : db.App.findById(1, { raw: true }))\n    .then((app) => {\n      const options = {\n        url: `${config.OAUTH_SERVER}${config.OAUTH_ENDPOINT}`,\n        auth: {\n          user: app.clientId,\n          pass: app.clientSecret,\n        },\n        headers: {\n          'user-agent': req.headers['user-agent'],\n          'x-forwarded-for': req.headers['x-forwarded-for'] || req.connection.remoteAddress,\n        },\n      };\n\n      options.form = code\n        ? { grant_type: 'authorization_code', redirect_uri: `${app.redirectUri}`, code }\n        : { grant_type: 'password', username: req.body.username, password: req.body.password };\n\n      request.post(options, (err, apires, body) => {\n        if (err) return res.status(500).json({ err, body });\n        return res.status(apires.statusCode).send(body);\n      });\n    });\n}\n\nexport function refresh(req, res, next) {\n  return db.App\n    .find({\n      include: [{\n        model: db.RefreshToken,\n        where: { refreshToken: req.body.refresh_token },\n        required: true,\n      }],\n    })\n    .then((app) => {\n      if (!app) return res.status(400).json({ message: 'Invalid Token' });\n      const options = {\n        url: `${config.OAUTH_SERVER}${config.OAUTH_ENDPOINT}`,\n        auth: {\n          user: app.clientId,\n          pass: app.clientSecret,\n        },\n        form: {\n          grant_type: 'refresh_token',\n          refresh_token: req.body.refreshToken,\n        },\n        headers: {\n          'user-agent': req.headers['user-agent'],\n          'x-forwarded-for': req.headers['x-forwarded-for'] || req.connection.remoteAddress,\n        },\n      };\n      return request\n        .post(options, (err, apires, body) => {\n          if (err) return next(err)\n          return res.status(apires.statusCode).send(body);\n        });\n    });\n}\n\nexport function logout(req, res, next) {\n  return oAuthModel\n    .revokeToken(req.body.access_token)\n    .then(up => res.status(200).json(up))\n    .catch(next);\n}\n\nexport function duplicate(req, res, next) {\n  const mobile = `91${req.query.mobile}`;\n  return db.User\n    .count({ where: { mobile } })\n    .then(data => res.json({ mobile: !!data }))\n    .catch(next);\n}\n\nexport function update(req, res, next) {\n  const id = req.user.id || req.params.id;\n  const user = req.body;\n  delete user.id;\n  return db.User\n    .update(user, { where: { id } })\n    .then(() => res.json({ id }))\n    .catch(next);\n}\n\n// Check email and phone exists\nexport function checkExists(req, res, next) {\n  return db.User\n    .checkExists(db, req.query.email, req.query.mobile)\n    .then(status => res.json(status))\n    .catch(next);\n}\n\nexport function otpLogin(req, res, next) {\n  return db.User\n    .findOrCreate({\n      where: {\n        mobile: req.body.username || req.body.mobile,\n      },\n      attributes: ['id', 'otpStatus', 'otp', 'mobile'],\n    }).then(([user, newUser]) => {\n      if (!user) {\n        return res.status(400).json({\n          message: 'User Details not matching with our records. Please contact support',\n        });\n      }\n\n      const otp = user.otpStatus === 1 && user.otp\n        ? user.otp\n        : Math.floor(Math.random() * 90000) + 10000;\n\n      const text = `${otp} is your OTP. Treat this as confidential. Sharing it with anyone gives` +\n        'them full access to your account. We never call you to verify OTP.';\n      if (user.mobile) sms({ to: user.mobile, text });\n      db.User\n        .update({ otp, otpStatus: 1 }, { where: { id: user.id } })\n        .catch(err => logger.error('user.ctrl/otp', err));\n      return res.json({ message: 'success', id: user.id, newUser });\n    }).catch(next);\n}\n\nexport function otpSend(req, res, next) {\n  db.User.find({\n    where: {\n      $or: {\n        email: req.body.username,\n        mobile: req.body.username,\n      },\n    },\n    attributes: ['id', 'otpStatus', 'otp', 'mobile'],\n  }).then((user) => {\n    if (!user) {\n      return res.status(400).json({\n        message: 'User Details not matching with our records. Please contact support',\n      });\n    }\n\n    const otp = user.otpStatus === 1 && user.otp\n      ? user.otp\n      : Math.floor(Math.random() * 90000) + 10000;\n\n    const text = `${otp} is your OTP. Treat this as confidential. Sharing it with anyone gives` +\n      'them full access to your account. We never call you to verify OTP.';\n    if (user.mobile) sms({ to: user.mobile, text });\n    db.User\n      .update({ otp, otpStatus: 1 }, { where: { id: user.id } })\n      .catch(err => logger.error('user.ctrl/otp', err));\n    return res.json({ message: 'success', id: user.id });\n  }).catch(next);\n}\n\nexport function otpVerify(req, res, next) {\n  db.User.find({\n    attributes: ['id'],\n    where: {\n      $or: [{ id: req.body.id }, { mobile: req.body.mobile }],\n      otp: req.body.otp,\n    },\n  })\n    .then((user) => {\n      if (!user) return res.status(400).json({ error_description: 'Invalid OTP' });\n      user\n        .update({ otpStatus: 0 })\n        .catch(err => logger.error('user.ctrl/otpVerify', err));\n      return res.json({ message: 'success', id: user.id });\n    }).catch(next);\n}\n\n\n// Creates a new User in the DB\nexport function passwordChange(req, res, next) {\n  return db.User.find({\n    where: {\n      id: req.body.id,\n      otp: req.body.otp,\n    },\n    attributes: ['id', 'mobile', 'email', 'name'],\n  }).then((u) => {\n    if (!u) {\n      return res\n        .status(400)\n        .json({ error: 'Invalid password', error_description: 'Invalid current password' });\n    }\n\n    return u.update({ password: req.body.password })\n      .then(() => {\n        res.status(204).end();\n        u.revokeTokens(db); // revoke all\n        const { id, name, mobile, email } = u;\n        return slack(`Password change: ${id}, ${name}, ${mobile}, ${email}`);\n      });\n  })\n    .catch(next);\n}\n\nexport function sendLogin(req, res, next) {\n  return db.User\n    .find({ where: { id: req.params.id } })\n    .then((user) => {\n      if (!user) return res.status(400).end();\n      const otp = user.otpStatus === 1 && user.otp\n        ? user.otp\n        : Math.floor(Math.random() * 90000) + 10000;\n\n      const text = `Your account has been created click on the link to login ${\n        req.origin}/home?otp=${otp}&id=${user.mobile}`;\n\n      if (user.mobile) sms({ to: user.mobile, text });\n      db.User\n        .update({ otp, otpStatus: 1 }, { where: { id: user.id } })\n        .catch(err => logger.error('user.ctrl/otp', err));\n      return res.json({ message: 'success', id: user.id });\n    })\n    .catch(next);\n}\n\nexport function loginUid(req, res, next) {\n  return res.status(500).json({});\n}\n\nexport function addSellingRootUser(req, res, next) {\n  const { userId, routeId, limit } = req.body;\n  if (!userId || !routeId || !limit || req.user.roleId !== 1) {\n    return res.status(400).json({ message: 'Invalid Request.' });\n  }\n  return db.Selling.create({ userId,\n    routeId,\n    limit: Number(limit),\n    createdBy: req.user.id,\n    updatedBy: req.user.id })\n    .then(() => res.status(202).end())\n    .catch(next);\n}\n\nexport function addSelling(req, res, next) {\n  const { userId, sendingUserId, routeId, limit, fromUserId } = req.body;\n  if (!userId || !sendingUserId || !routeId || !limit) {\n    return res.status(400).json({ message: 'Invalid Request.' });\n  }\n  if (req.user[`sellingBalance${getRouteType(routeId)}`] < limit) {\n    return res.status(400).json({ message: 'Limit Exceeded.' });\n  }\n  return db.Selling.create({ userId,\n    sendingUserId,\n    routeId,\n    limit: Number(limit),\n    fromUserId: fromUserId || req.user.id,\n    createdBy: req.user.id,\n    updatedBy: req.user.id })\n    .then(() => res.status(202).end())\n    .catch(next);\n}\n"]}