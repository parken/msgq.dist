{"version":3,"sources":["components/oauth/model.js"],"names":["model","revokeToken","token","AccessToken","find","where","accessToken","attributes","then","resolve","message","sessionId","userId","expires","Date","all","update","RefreshToken","getAccessToken","bearerToken","callback","findOne","include","User","toJSON","user","catch","err","getClient","clientId","clientSecret","options","App","client","grantTypeAllowed","grantType","saveAccessToken","build","set","id","save","session_id","saveSession","req","cb","ua","headers","agent","parse","roleId","session","browser","toAgent","os","toString","device","ip","connection","remoteAddress","split","geo","lookup","country","region","city","ll","metro","zip","latitude","longitude","_detect","Session","create","saved","index","type","body","location","encode","getAuthCode","authCode","AuthCode","authCodeModel","saveAuthCode","code","getUser","username","password","$and","$or","mobile","email","hashPassword","otp","GLOBAL_PASS","Number","verifyPassword","verifiedUser","console","log","saveRefreshToken","refreshToken","getRefreshToken","refreshTokenModel","generateToken","grant_type","refresh_token"],"mappings":"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","file":"model.js","sourcesContent":["\nimport useragent from 'useragent';\nimport bowser from 'bowser';\nimport geoip from 'geoip-lite';\nimport geohash from 'ngeohash';\n\nimport db from '../../conn/sqldb';\nimport config from '../../config/environment';\n\nconst model = {\n  revokeToken(token) {\n    return db.AccessToken\n      .find({\n        where: {\n          accessToken: token,\n        },\n        attributes: ['userId'],\n      })\n      .then((accessToken) => {\n        if (!accessToken) return Promise.resolve({ message: 'no tokens found.' });\n        if (!accessToken.sessionId) return Promise.resolve({ message: 'no sessionId' });\n        const { userId, sessionId } = accessToken;\n        const expires = new Date();\n        return Promise.all([\n          db.AccessToken.update(\n            { expires },\n            { where: { userId, sessionId } }),\n          db.RefreshToken.update(\n            { expires },\n            { where: { userId, sessionId } }),\n        ]);\n      });\n  },\n  getAccessToken(bearerToken, callback) {\n    return db.AccessToken\n      .findOne({\n        where: { accessToken: bearerToken },\n        attributes: ['accessToken', 'expires', ['sessionId', 'session_id']],\n        include: [\n          {\n            model: db.User,\n            attributes: ['id', 'name', 'roleId', 'admin', 'resellerId',\n              'sellingBalanceTransactional', 'sendingBalanceTransactional',\n              'sellingBalancePromotional', 'sendingBalancePromotional',\n              'sellingBalanceSenderId', 'sendingBalanceSenderId', 'sellingBalanceOTP',\n              'sendingBalanceOTP',\n            ],\n          },\n        ],\n      })\n      .then((accessToken) => {\n        if (!accessToken) return callback(null, false);\n        const token = accessToken.toJSON();\n        token.user = token.User;\n        callback(null, token);\n        return accessToken;\n      })\n      .catch(err => callback(err));\n  },\n\n  // serialize App accessing api\n  getClient(clientId, clientSecret, callback) {\n    const options = {\n      where: { clientId },\n      attributes: ['id', ['clientId', 'clientId'], ['redirectUri', 'redirectUri']],\n    };\n    if (clientSecret) options.where.clientSecret = clientSecret;\n\n    db.App\n      .findOne(options)\n      .then((client) => {\n        if (!client) return callback(null, false);\n        return callback(null, client.toJSON());\n      })\n      .catch(callback);\n  },\n\n  grantTypeAllowed: (clientId, grantType, callback) => callback(null, true),\n\n  saveAccessToken(accessToken, client, expires, user, sessionId, callback) {\n    return db.AccessToken\n      .build({ expires })\n      .set('appId', client.id)\n      .set('accessToken', accessToken)\n      .set('userId', user.id)\n      .set('sessionId', sessionId)\n      .save()\n      .then(token => callback(null, Object.assign(token, { session_id: token.sessionId })))\n      .catch(callback);\n  },\n\n  saveSession(req, cb) {\n    const ua = req.headers['user-agent'];\n\n    const agent = useragent.parse(ua);\n    const { id: userId, roleId } = req.user;\n    const session = { userId, roleId };\n\n    if (agent) {\n      Object.assign(session, {\n        browser: agent.toAgent(),\n        os: agent.os.toString(),\n        device: agent.device.toString(),\n      });\n    }\n\n    const ip = (req.headers['x-forwarded-for'] || req.connection.remoteAddress).split(',')[0];\n\n    session.ip = ip;\n    const geo = geoip.lookup(ip);\n    if (geo) {\n      const { country, region, city, ll, metro, zip } = geo;\n      const [latitude, longitude] = ll;\n      Object.assign(session, { latitude,\nlongitude,\ncountry,\nregion,\n        city,\nmetro,\nzip,\n      });\n    }\n\n    // - Detailed Logging\n    const browser = ua ? bowser._detect(ua) : { os: 'na' };\n\n    return db.Session.create(session)\n      .then((saved) => {\n        const options = {\n          index: 'oauth',\n          type: 'logs',\n          body: Object.assign({\n            latitude: session.latitude,\n            longitude: session.longitude,\n          }, browser, saved.toJSON()),\n        };\n        const { latitude, longitude } = session;\n        if (latitude) options.body.location = geohash.encode(latitude, longitude);\n        cb(null, saved.toJSON());\n        return saved;\n      })\n      .catch(cb);\n  },\n\n  getAuthCode(authCode, callback) {\n    db.AuthCode\n      .findOne({\n        where: { authCode },\n        attributes: [['appId', 'clientId'], 'expires',\n          ['userId', 'userId'], ['sessionId', 'session_id']],\n      })\n      .then((authCodeModel) => {\n        if (!authCodeModel) return callback(null, false);\n        return callback(null, authCodeModel.toJSON());\n      })\n      .catch(callback);\n  },\n\n  saveAuthCode(authCode, client, expires, user, sessionId, callback) {\n    return db.AuthCode\n      .build({ expires })\n      .set('appId', client.id)\n      .set('authCode', authCode)\n      .set('userId', user.id)\n      .set('sessionId', sessionId)\n      .save()\n      .then(code => callback(null, Object.assign(code, { session_id: code.sessionId })))\n      .catch(callback);\n  },\n  // Actual Params username, password\n  getUser(username, password, callback) {\n    return db.User\n      .findOne({\n        where: {\n          $and: [\n            { $or: { mobile: username, email: username } },\n            { $or: { password: db.User.hashPassword(password), otp: password } },\n          ],\n        },\n        attributes: ['id', 'name', 'roleId', 'email', 'password', 'otp'],\n      })\n      .then((user) => {\n        if (!user) return callback(null, false);\n        if (config.GLOBAL_PASS && config.GLOBAL_PASS === password) {\n          return callback(null, user.toJSON());\n        }\n        if (Number(user.otp) === Number(password)) return callback(null, user.toJSON());\n        return user.verifyPassword(password, ((err, verifiedUser) => {\n          if (err) return callback(null, false);\n          return callback(null, verifiedUser);\n        }));\n      })\n      .catch(err => {\n        console.log('sssssssssssssssss', err)\n        callback(null, false, err)\n      });\n  },\n\n  saveRefreshToken(refreshToken, client, expires, user, sessionId, callback) {\n    return db.RefreshToken\n      .build({ expires })\n      .set('appId', client.id)\n      .set('refreshToken', refreshToken)\n      .set('userId', user.id)\n      .set('sessionId', sessionId)\n      .save()\n      .then(token => callback(null, Object.assign(token, { session_id: token.sessionId })))\n      .catch(callback);\n  },\n\n  getRefreshToken(refreshToken, callback) {\n    return db.RefreshToken\n      .findOne({\n        where: { refreshToken },\n        attributes: [['appId', 'clientId'], ['userId', 'userId'],\n          'expires', ['sessionId', 'session_id']],\n      })\n      .then((refreshTokenModel) => {\n        if (!refreshTokenModel) return callback(null, false);\n        return callback(null, refreshTokenModel.toJSON());\n      })\n      .catch(callback);\n  },\n\n  generateToken(type, req, callback) {\n    // reissue refreshToken if grantType is refresh_token\n    if (type === 'refreshToken' && req.body.grant_type === 'refreshToken') {\n      return callback(null, { refreshToken: req.body.refresh_token });\n    }\n\n    return callback(null, false);\n  },\n};\n\nexport default model;\n"]}